<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Page</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.8.1/font/bootstrap-icons.min.css" rel="stylesheet">
    <style>
        .wide-container {
            max-width: 90%;
        }
        .full-height {
            height: auto;
        }
        .thin-grey-border th,
        .thin-grey-border td {
            border: 1px solid #dee2e6;
        }
        .small-text {
            font-size: 0.85rem;
        }
        .custom-table-header {
            background-color: #F1F5FA;
        }
        .card-header .card-title {
            margin-bottom: 0.25rem;
        }
        .card-header small {
            margin-bottom: 0.5rem;
        }
        .custom-button {
            height: 1.65rem;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.375rem 0.75rem;
        }
    </style>
</head>

<body>

<div th:replace="fragments/navbar :: navbar"></div>

<div class="container-fluid bg-light wide-container full-height p-4">

    <div class="row mb-4">
       <div class="col">
            <h4>Your Portfolio</h4>
        </div>
    </div>

    <div th:if="${successMessage}" class="alert alert-success text-center text-dark fs-5" role="alert"><span th:text="${successMessage}"></span></div>
    <div th:if="${errorMessage}" class="alert alert-danger text-center text-dark fs-5" role="alert"><span th:text="${errorMessage}"></span></div>

    <div class="row mb-4 g-3">
        <!-- Stock data and company summary cards -->
        <div class="col d-flex flex-column justify-content-start gap-3">
            <div class="d-flex gap-4">
                <!-- Stock information cards -->
                <div class="card" style="width: 18rem; height: 8rem;">
                    <div class="card-header">Current Balance</div>
                    <div class="card-body d-flex align-items-center h-100">
                        <h4 class="m-0" th:text="'$' + (${balance} != null ? ${#numbers.formatDecimal(balance, 1, 'COMMA', 2, 'POINT')} : '0.00')"></h4>
                    </div>
                </div>
                <div class="card" style="width: 18rem; height: 8rem;">
                    <div class="card-header">Total Cost</div>
                    <div class="card-body d-flex align-items-center h-100">
                        <h4 class="m-0" th:text="'$' + (${totalCost} != null ? ${#numbers.formatDecimal(totalCost, 2, 'COMMA', 2, 'POINT')} : '0.00')"></h4>
                    </div>
                </div>
                <div class="card" style="width: 18rem; height: 8rem;">
                    <div class="card-header">Total Value</div>
                    <div class="card-body d-flex align-items-center h-100">
                        <h4 class="m-0" th:text="'$' + (${totalValue} != null ? ${#numbers.formatDecimal(totalValue, 2, 'COMMA', 2, 'POINT')} : '0.00')"></h4>
                    </div>
                </div>
                <div class="card" style="width: 18rem; height: 8rem;">
                    <div class="card-header">Total Change</div>
                    <div class="card-body d-flex align-items-center h-100">
                        <h4 class="m-0">
                            <span th:text="'$' + (${totalChangeValue} != null ? ${#numbers.formatDecimal(totalChangeValue, 2, 'COMMA', 2, 'POINT')} : '0.00')"></span>
                            (<span th:class="${totalChangePercent >= 0 ? 'text-success' : 'text-danger'}"
                                   th:text="(${totalChangePercent} != null ? ${#numbers.formatDecimal(totalChangePercent, 1, 'COMMA', 2, 'POINT')} : '0.00') + '%'"></span>)
                        </h4>
                    </div>
                </div>
            </div>

            <div class="card mb-4" style="width: 76.5rem; height: 40rem;">
                <div class="card-header">Investments</div>
                <div class="card-body p-4 pb-2">
                    <table class="table table-hover mb-0 thin-grey-border small-text">
                        <thead class="text-center custom-table-header">
                        <tr>
                            <th scope="col">Name</th>
                            <th scope="col">Quantity</th>
                            <th scope="col">Purchase Price</th>
                            <th scope="col">Cost</th>
                            <th scope="col">Value</th>
                            <th scope="col">Change</th>
                            <th scope="col">Actions</th>
                        </tr>
                        </thead>
                        <tbody class="text-center">

                        <tr th:each="item, iterStat : ${portfolio.items}">
                            <td class="align-middle text-center" th:text="${item.stock.name}"></td>
                            <td class="align-middle text-center">
                                <span th:if="${editingItemId != item.id}" th:text="${item.quantity}"></span>
                                <input class="form-control form-control-sm" style="text-align: center;" th:if="${editingItemId == item.id}" type="number" th:value="${item.quantity}" th:name="newQuantity" form="saveForm-${item.id}" />
                            </td>
                            <td class="align-middle text-center">
                                <span th:if="${editingItemId != item.id}" th:text="${#numbers.formatDecimal(item.purchasePrice, 1, 'COMMA', 2, 'POINT')}"></span>
                                <input class="form-control form-control-sm" style="text-align: center;" th:if="${editingItemId == item.id}" type="text" th:value="${item.purchasePrice}" th:name="newPurchasePrice" form="saveForm-${item.id}" />
                            </td>
                            <td class="align-middle text-center" th:text="${#numbers.formatDecimal(item.quantity * item.purchasePrice, 1, 'COMMA', 2, 'POINT')}"></td>
                            <td class="align-middle text-center" th:text="${#numbers.formatDecimal(item.quantity * item.stock.currentPrice, 1, 'COMMA', 2, 'POINT')}"></td>
                            <td class="align-middle text-center" th:text="${#numbers.formatDecimal((item.stock.currentPrice - item.purchasePrice) * item.quantity, 1, 'COMMA', 2, 'POINT')}"></td>
                            <td class="align-middle text-center">
                                <form th:if="${editingItemId == item.id}" id="saveForm-${item.id}" th:action="@{/portfolio/save}" method="post" class="d-inline-block">
                                    <input type="hidden" th:name="id" th:value="${item.id}" />
                                    <button type="submit" class="btn btn-primary btn-sm" title="Save">Save</button>
                                </form>
                                <a th:if="${editingItemId != item.id}" th:href="@{/portfolio/edit/(id=${item.id})}" class="bi bi-pencil-square mx-1" title="Edit"></a>
                                <a th:if="${editingItemId != item.id}" href="javascript:void(0)" class="bi bi-trash mx-1" title="Delete" th:data-item-id="${item.id}" data-bs-toggle="modal" data-bs-target="#deleteConfirmationModal"></a>
                            </td>
                        </tr>
                        <tr th:each="i : ${#numbers.sequence(1, 12)}">
                            <td>&nbsp;</td>
                            <td>&nbsp;</td>
                            <td>&nbsp;</td>
                            <td>&nbsp;</td>
                            <td>&nbsp;</td>
                            <td>&nbsp;</td>
                            <td>&nbsp;</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                <div class="d-flex justify-content-between align-items-end pt-4 px-4 pb-4">
                    <form th:action="@{/portfolio/updatePrices}" method="post" class="mb-4">
                        <button type="submit" class="btn btn-outline-secondary text-dark custom-button">Refresh Prices</button>
                    </form>
                    <nav aria-label="Page navigation" class="mb-4">
                        <ul class="pagination pagination-sm mb-0">
                            <li class="page-item"><a class="page-link" href="#">Previous</a></li>
                            <li class="page-item active" aria-current="page"><a class="page-link" href="#">1</a></li>
                            <li class="page-item"><a class="page-link" href="#">2</a></li>
                            <li class="page-item"><a class="page-link" href="#">3</a></li>
                            <li class="page-item"><a class="page-link" href="#">Next</a></li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>

        <div class="ms-auto" style="width: 22rem;">

            <div class="card" style="height: 49rem;">
                <div class="card-header">Portfolio Analysis</div>
                <div class="card-body">
                    <div class="text-center mb-4">
                        <h6 class="mb-3">Sector Allocation</h6>
                        <div id="sectorDistributionChart"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PortfolioItem stock delete confirmation modal -->
    <div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteModalLabel">Remove Stock?</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to remove this stock from your portfolio?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
                    <button type="button" class="btn btn-danger" id="confirmDelete" data-bs-dismiss="modal">Yes</button>
                </div>
            </div>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var deleteButton = document.getElementById('confirmDelete');

        deleteButton.addEventListener('click', function () {
            var modal = document.getElementById('deleteConfirmationModal');
            var itemId = modal.getAttribute('data-item-id');
            var bsModal = bootstrap.Modal.getInstance(modal);
            bsModal.hide();

            // Redirect after a short delay to ensure modal animation completes
            setTimeout(function() {
                window.location.href = '/portfolio/delete/' + itemId;
            }, 500);
        });

        var modal = document.getElementById('deleteConfirmationModal');
        modal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget; // Button that triggered the modal
            var itemId = button.getAttribute('data-item-id');
            modal.setAttribute('data-item-id', itemId); // Update modal's item ID
        });
    });
</script>

<script th:inline="javascript">
    /*<![CDATA[*/
    const hasData = [[${hasSectorData}]];
    let sectors, percentages, chartColors;
    if (hasData) {
        sectors = /*[[${sectorDistribution.keySet()}]]*/ [];
        percentages = /*[[${sectorDistribution.values()}]]*/ [];
        chartColors = ['#008FFB', '#00E396', '#FEB019', '#FF4560', '#775DD0', '#546E7A', '#26a69a', '#D10CE8'];
    } else {
        sectors = ['No Data'];
        percentages = [100]; // Show 100% of "No Data"
        chartColors = ['#A9A9A9']; // Grey (No Data)
    }

    const options = {
        series: percentages,
        chart: {
            type: 'donut',
            height: 250,
            toolbar: {
                show: true,
                tools: {
                    download: '<i class="bi bi-download"></i>',
                    zoom: '<i class="bi bi-zoom-in"></i>',
                    zoomout: '<i class="bi bi-zoom-out"></i>',
                    pan: '<i class="bi bi-arrows-move"></i>',
                    reset: '<i class="bi bi-arrow-counterclockwise"></i>',
                    customIcons: []
                }
            }
        },
        labels: sectors,
        plotOptions: {
            pie: {
                donut: {
                    labels: {
                        show: true,
                        total: {
                            show: true,
                            showAlways: true,
                            label: 'Total',
                            fontSize: '22px',
                            fontFamily: 'Helvetica, Arial, sans-serif',
                            fontWeight: 600,
                            color: '#373d3f',
                            formatter: function (w) {
                                return w.globals.seriesTotals.reduce((a, b) => {
                                    return a + b
                                }, 0)
                            }
                        }
                    }
                }
            }
        },
        legend: {
            position: 'bottom',
            horizontalAlign: 'center',
            fontSize: '14px',
            markers: {
                width: 10,
                height: 10
            },
        },
        dataLabels: {
            enabled: true
        },
        tooltip: {
            y: {
                formatter: function(value) {
                    return hasData ? `${value}%` : 'N/A';
                }
            }
        },
        colors: chartColors,
        responsive: [{
            breakpoint: 480,
            options: {
                chart: {
                    width: 200
                },
                legend: {
                    position: 'bottom'
                }
            }
        }]
    };

    const chart = new ApexCharts(document.querySelector("#sectorDistributionChart"), options);
    chart.render();
    /*]]>*/
</script>

</body>
</html>